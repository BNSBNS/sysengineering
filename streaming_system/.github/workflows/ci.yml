name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install ruff black mypy
      - run: ruff check src/ tests/
      - run: black --check src/ tests/
      - run: mypy src/

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: streaming_system
          environment-file: conda.yaml
          python-version: "3.12"
      - name: Install package
        shell: bash -l {0}
        run: pip install -e ".[dev]"
      - name: Run unit tests
        shell: bash -l {0}
        run: pytest tests/unit/ -v -m unit
      - name: Run property tests
        shell: bash -l {0}
        run: pytest tests/property/ -v -m property

  integration:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Start broker cluster
        run: docker-compose up -d broker1 broker2 broker3
      - name: Wait for cluster
        run: sleep 30
      - name: Run integration tests
        run: docker-compose --profile test run --rm streaming_test
      - name: Stop cluster
        run: docker-compose down

  benchmark:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: streaming_system
          environment-file: conda.yaml
      - name: Run benchmarks
        shell: bash -l {0}
        run: pytest tests/benchmarks/ -v --benchmark-json=results.json
      - uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: results.json
