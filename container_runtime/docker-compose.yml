version: "3.8"

services:
  container_runtime:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: container_runtime
    privileged: true  # Required for namespace/cgroup operations
    ports:
      - "50052:50052"  # gRPC API
      - "8002:8002"    # Prometheus metrics
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - runtime_data:/var/lib/containers
      - runtime_state:/run/containers
      - ./src:/app/src:ro
    environment:
      - CONTAINER_RUNTIME_LOG_LEVEL=INFO
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=container_runtime
    networks:
      - runtime_network
    restart: unless-stopped

  container_runtime_test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: container_runtime_test
    privileged: true
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
    command: ["pytest", "-v", "--tb=short"]
    profiles:
      - test

networks:
  runtime_network:
    driver: bridge

volumes:
  runtime_data:
  runtime_state:
